{% extends base.html %}

{% block style %}
{% set WIDTH, HEIGHT = 1366, 700 %}
body { width: {{ WIDTH }}px; margin: 0 auto; position: relative; }
h1 { font-size: 350%; height: 68px; line-height: 68px; font-variant: small-caps; background-color: #000; color: #fff; padding: 0 20px; }
h1 span { font-size: 50%; color: #ccc; }
#legend { height: 68px; width: 50%; top: 0; right: 0; position: absolute; color: #fff; text-align: right; padding: 0 10px; font-family: Georgia, serif; font-size: 14px; }
#legend b { padding: 0 4px; font-family: Calibri, sans-serif; }
#treemap { display: block; margin: 0 auto; }
#treemap rect { stroke-width: 0.4; stroke: rgba(255,255,255,1); }
#treemap rect.selected { stroke-width: 2; stroke: #000; }
#name { display: none; position: absolute; font-size: 125%; padding: 0.2em 0.5em; background-color: #ffc; border: 1px solid #ddd; max-width: 300px;
  -webkit-box-shadow: 1px 1px 4px #888; /* Saf3.0+, Chrome */
     -moz-box-shadow: 1px 1px 4px #888; /* FF3.5 - 3.6 */
          box-shadow: 1px 1px 4px #888; /* Opera 10.5, IE9, FF4+, Chrome 10+ */
}
{% end %}

{% block body %}

{% code %}
import treemap
import numpy
import color
import datetime

# Convert 'Runs' column from str to int. "0*" --> 0
data.replace('*',   '', strict=False, cols=['Runs'])
data.replace('DNB', '0', strict=False, cols=['Runs'])
data1 = data.addcols([data['Runs'].astype(float)], names=['Runs'])

# Ignore zero scores
data1 = data1[data1['Runs'] > 0]

country, adjusted = args[:2]
data1   = data1[data1['Country'] == country] if country != 'World' else data1
players = 50                                 if country != 'World' else 100
is_adjusted = adjusted.lower().startswith('adjusted')

GRADIENT = ((20, '#FF4142'), (80, '#FFD026'), (140, '#AAE817'))

# adjust for increasing ScoreRate over time
# It's been growing at 0.001385 a day (about 5.1 a decade)
RATE = 0.001385
data1 = data1.addcols([data1['ScoreRate']], names=['Effective ScoreRate'])
meandate = datetime.datetime(year=1998, month=5, day=1)
for row in data1:
    if is_adjusted:
        row['Effective ScoreRate'] -= (datetime.datetime.strptime(row['MatchDate'], '%d/%m/%Y') - meandate).days * RATE

summary = data1.aggregate(On=['Player'], AggFunc=lambda x:None, AggFuncDict={'Runs':numpy.nansum})
summary.sort(order=['Runs'])
summary = summary[::-1][:players]
tm = list(treemap.Squarified(x=0, y=0, width=WIDTH, height=HEIGHT, data=summary, size=lambda x:x['Runs']).draw())

def player_treemap(x, y, width, height, value):
    """Returns the filtered treemap for a single player"""
    summary2 = data1[data1['Player'] == value['Player']]
    summary2.sort(order=['Runs'])
    summary2 = summary2[::-1]
    return treemap.Squarified(x=x, y=y, width=width, height=height, data=summary2, size=lambda x:x['Runs'])

{% end %}


{% apply single_line %}
 <h1>{{ country }} ODI batting performance <span>by Gramener</span></h1>
 <div id="legend">
  Here's the one day batting performance of {{ country }}'s top {{ players }} run-scorers in ODIs.
  <br/>Each box represents one match. The size is the number of runs scored.
  <br/>The color scale is based on the strike rate &#160;
   {% for value, gradientcolor in GRADIENT %}
    <b style="width:30px; background-color:{{ gradientcolor }}">{{ value }}</b>
   {% end %}
 </div>
 <svg id="treemap" width="{{ WIDTH }}" height="{{ HEIGHT }}" xmlns="http://www.w3.org/2000/svg">
  {% for x, y, width, height, value in tm %}
   {% for x2, y2, width2, height2, v2 in player_treemap(x, y, width, height, value).draw() %}
    <rect x="{{ '%0.2f' % x2 }}" y="{{ '%0.2f' % y2 }}" width="{{ '%0.2f' % width2 }}" height="{{ '%0.2f' % height2 }}" fill="{{ color.gradient(v2['Effective ScoreRate'], GRADIENT) }}" title=
       "{{ int(v2['Runs']) }} runs at {{ '%0.1f' % v2['ScoreRate'] }}{{ (' (%0.1f adjusted)' % v2['Effective ScoreRate']) if is_adjusted else '' }} S/R against {{ v2['Versus'] }} at {{ escape(v2['Ground']) }} on {{ v2['MatchDate'] }}" />
   {% end %}
  {% end %}

  {% for x, y, width, height, value in tm %}
   {% set H = max(4, min(width/6,height/3)) %}
   {% set words = value['Player'].split(' ') %}
   {% if len(words) == 1 %}
   <text x="{{ '%0.2f' % (x+width/2) }}" y="{{ '%0.2f' % (y+height/2) }}" dominant-baseline="middle" text-anchor="middle" style="font-size:{{ H }}px">{{ words[0] }}</text>
   {% else %}
   <text x="{{ '%0.2f' % (x+width/2) }}" y="{{ '%0.2f' % (y+height/2-H/2) }}" dominant-baseline="middle" text-anchor="middle" style="font-size:{{ H }}px">{{ ' '.join(words[:1]) }}</text>
   <text x="{{ '%0.2f' % (x+width/2) }}" y="{{ '%0.2f' % (y+height/2+H/2) }}" dominant-baseline="middle" text-anchor="middle" style="font-size:{{ H }}px">{{ ' '.join(words[1:]) }}</text>
   {% end %}
  {% end %}
 </svg>
 <div id="name"></div>
{% end %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<script>
var $selected;
var $name = $('#name');

$('rect').hover(function() {
  if ($selected) { $selected.removeAttr('class'); }
  $selected = $(this).attr('class', 'selected');
  var $this = $(this),
      pos = $this.offset();
  pos.top += 20;
  pos.left += 20;
  $name.text($this.attr('title')).offset(pos).show();
});
$('#treemap').hover(function() { }, function() {
   $name.hide();
   $selected.removeAttr('class');
})
</script>
{% end %}
